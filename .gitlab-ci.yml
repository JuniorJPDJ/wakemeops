workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

variables:
  WAKEMEBOT_IMAGE: "upciti/wakemebot:main"

stages:
  - update
  - build
  - test
  - push
  - publish
  - pages

.ops2deb_build: &ops2deb_build
  - mkdir -p ${OPS2DEB_WORK_DIR}
  - (curl -L ${CI_PAGES_URL}/repo-state-${repo}.json | jq || echo "[]") > repo-state-${repo}.json
  - wakemebot generate ops2deb-${repo}.yml repo-state-${repo}.json
  - if [ -z "$(ls -A $OPS2DEB_WORK_DIR)" ]; then exit 0; fi # if no changes
  - ops2deb build

.ops2deb_update: &ops2deb_update
  - for repo in $(ls ops2deb-* | cut -f2 -d "-" | cut -f1 -d "."); do OPS2DEB_OUTPUT_FILE=ops2deb-${repo}.log OPS2DEB_CONFIG="ops2deb-${repo}.yml" ops2deb update; done

.enable_ssh: &enable_ssh
  - eval $(ssh-agent -s)
  - echo "${SSH_PRIVATE_KEY}" | tr -d '\r' | ssh-add -
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh || echo
  - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts

.git_configure: &git_configure
  - git config --replace-all user.name $GITLAB_USER_NAME
  - git config --replace-all user.email $GITLAB_USER_EMAIL
  - git config push.default simple

.git_commit_push: &git_commit_push
  - git remote set-url --push origin git@$CI_SERVER_HOST:$CI_PROJECT_PATH.git
  - branch="feature/update-packages-$(date '+%Y%m%d%H%M%S')"
  - git checkout -b ${branch}
  - git add ops2deb-*.yml
  - >
    echo "feature(bot): update packages\n" > message.log
  - cat ops2deb-*.log >> message.log || true
  - git commit -m "$(cat message.log)"
  - git push -o merge_request.create -o merge_request.target=${CI_DEFAULT_BRANCH} -o merge_request.merge_when_pipeline_succeeds --set-upstream origin ${branch}

build:
  image: $WAKEMEBOT_IMAGE
  stage: build
  tags: ["wakemebot"]
  script:
    - *ops2deb_build
  variables:
    OPS2DEB_WORK_DIR: "build/${repo}"
    OPS2DEB_CONFIG: "ops2deb-${repo}.yml"
  parallel:
    matrix:
      - repo: devops
      - repo: secops
      - repo: terminal
  artifacts:
    paths:
      - build/**/*deb
    expire_in: 2 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: on_success

test_package:
  stage: test
  image: ${DISTRO}:${VERSION}
  before_script:
    - apt-get update && apt-get install -yq --no-install-recommends curl gnupg2 ca-certificates
    - curl https://gitlab.com/upciti/wakemeops/-/snippets/2189589/raw/main/install.sh | bash
    - export PACKAGE_PATH=$(find ./build -name "*.deb")
    - dpkg -i $PACKAGE_PATH || true
    - apt-get update -yq && apt-get install -fy
  script:
    - for p in $PACKAGE_PATH; do n=$(dpkg --info $p | sed -n "s/ Package. \(.*\)/\1/p"); dpkg -s $n || exit 77; done
  parallel:
    matrix:
      - DISTRO: ubuntu
        VERSION: ["16.04", "18.04", "20.04", "21.04"]
      - DISTRO: debian
        VERSION:
          ["bookworm-slim", "bullseye-slim", "buster-slim", "stretch-slim"]
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: on_success

push:
  image: $WAKEMEBOT_IMAGE
  stage: push
  tags: ["wakemebot"]
  script:
    - if [ -z "$(ls -A build/${repo}/)" ]; then exit 0; fi # if no build
    - wakemebot aptly push wakemeops-${repo} build/${repo}/*.deb --server /host/data/aptly/aptly.sock
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  parallel:
    matrix:
      - repo: devops
      - repo: secops
      - repo: terminal

publish:
  image: $WAKEMEBOT_IMAGE
  stage: publish
  tags: ["wakemebot"]
  script:
    - >
      curl -v -f -s -XPUT --unix-socket /host/data/aptly/aptly.sock -H 'Content-Type: application/json' --data "{\"ForceOverwrite\":true, \"Signing\":{\"GpgKey\":\"wakemebot-dev@upciti.com\", \"Batch\":true}}" "http://_/api/publish/s3:wakemeops-eu-west-3:./stable"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

pages:
  image: $WAKEMEBOT_IMAGE
  stage: pages
  tags: ["wakemebot"]
  before_script:
    - mkdir public
  script:
    - for repo in $(ls ops2deb-* | cut -f2 -d "-" | cut -f1 -d "."); do wakemebot aptly export wakemeops-${repo} --server /host/data/aptly/aptly.sock > ./public/repo-state-${repo}.json; done
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

update:
  image: $WAKEMEBOT_IMAGE
  stage: update
  tags: ["wakemebot"]
  before_script:
    - *enable_ssh
    - *git_configure
  script:
    - *ops2deb_update
    - git update-index -q --really-refresh
    - if git diff-index HEAD --quiet; then exit 0; fi # exit if no changes
    - *git_commit_push
  variables:
    GIT_STRATEGY: clone
    GITLAB_USER_NAME: "wakemebot"
    GITLAB_USER_EMAIL: "wakemebot@upciti.com"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
